<?php

namespace App\Http\Controllers\chat;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\User;
use App\Models\message;
use App\Models\Notification;
use Illuminate\Support\Facades\DB;

class ChatController extends Controller
{
    public function index()
    {
        $currentUser = auth()->user();
        
        // Get all users except current user and exclude Non homeowners role
        $users = User::where('id', '!=', $currentUser->id)
            ->where(function($query) {
                $query->where('role', '!=', 'non home owners')
                      ->where('role', '!=', 'non-homeowner')
                      ->where('role', '!=', 'non homeowner')
                      ->where('role', '!=', 'non-homeowners');
            })
            ->select('id', 'name', 'photo', 'is_online', 'email', 'role', 'contact_number', 'street', 'lot', 'block')
            ->orderBy('name')
            ->get();
        
        // Get unread message counts for each user
        $unreadCounts = message::where('to_id', $currentUser->id)
            ->where('status', 'unread')
            ->select('from_id', DB::raw('COUNT(*) as unread_count'))
            ->groupBy('from_id')
            ->pluck('unread_count', 'from_id');
        
        // Add unread counts to users
        $users = $users->map(function($user) use ($unreadCounts) {
            $user->unread_count = $unreadCounts->get($user->id, 0);
            return $user;
        });
        
        // Get users with recent conversations (exclude Non homeowners role)
        $recentChats = DB::table('messages')
            ->select('users.id', 'users.name', 'users.photo', 'users.is_online', 
                     DB::raw('MAX(messages.created_at) as last_message_time'))
            ->join('users', function($join) use ($currentUser) {
                $join->on(function($query) use ($currentUser) {
                    $query->where('messages.from_id', '=', 'users.id')
                          ->where('messages.to_id', '=', $currentUser->id);
                })->orOn(function($query) use ($currentUser) {
                    $query->where('messages.to_id', '=', 'users.id')
                          ->where('messages.from_id', '=', $currentUser->id);
                });
            })
            ->where('users.id', '!=', $currentUser->id)
            ->where('users.role', '!=', 'non home owners')
            ->where('users.role', '!=', 'non-homeowner')
            ->where('users.role', '!=', 'non homeowner')
            ->where('users.role', '!=', 'non-homeowners')
            ->whereNull('messages.deleted_at')
            ->groupBy('users.id', 'users.name', 'users.photo', 'users.is_online')
            ->orderBy('last_message_time', 'desc')
            ->limit(10)
            ->get();
        
        // Add unread counts to recent chats
        $recentChats = $recentChats->map(function($chat) use ($unreadCounts) {
            $chat->unread_count = $unreadCounts->get($chat->id, 0);
            return $chat;
        });
        
        return view('chat.chat', compact('users', 'recentChats', 'currentUser'));
    }
    
    public function getMessages($userId)
    {
        $currentUser = auth()->user();
        
        $messages = message::where(function($query) use ($currentUser, $userId) {
            $query->where('from_id', $currentUser->id)
                  ->where('to_id', $userId);
        })->orWhere(function($query) use ($currentUser, $userId) {
            $query->where('from_id', $userId)
                  ->where('to_id', $currentUser->id);
        })
        ->with(['user:id,name,photo', 'toUser:id,name,photo'])
        ->orderBy('created_at', 'asc')
        ->get();
        
        // Mark messages as read
        message::where('from_id', $userId)
            ->where('to_id', $currentUser->id)
            ->where('status', 'unread')
            ->update(['status' => 'read']);
        
        // Get the chat user's online status
        $chatUser = User::select('id', 'name', 'is_online')->find($userId);
        
        return response()->json([
            'success' => true,
            'messages' => $messages,
            'currentUserId' => $currentUser->id,
            'chatUser' => $chatUser
        ]);
    }
    
    public function sendMessage(Request $request)
    {
        $request->validate([
            'to_id' => 'required|exists:users,id',
            'message' => 'required|string|max:5000'
        ]);
        
        $currentUser = auth()->user();
        
        $message = message::create([
            'from_id' => $currentUser->id,
            'to_id' => $request->to_id,
            'message' => $request->message,
            'status' => 'unread'
        ]);
        
        // Find chat module for notification_settings_id
        $chatModule = \App\Models\module::where(function($m) {
            $m->where('module_name', 'Chat')
              ->orWhere('module_name', 'chat')
              ->orWhere('module_name', 'Chat Management')
              ->orWhere('module_name', 'chat management');
        })->where('status', 'active')->first();
        
        $notificationSettingId = null;
        if ($chatModule) {
            $notificationSetting = \App\Models\notification_settings::where('users_id', $request->to_id)
                ->where('module_id', $chatModule->id)
                ->where('status', 'active')
                ->first();
            
            if ($notificationSetting) {
                $notificationSettingId = $notificationSetting->id;
            }
        }
        
        // Create notification for the recipient (only if they have notification setting enabled)
        if ($notificationSettingId) {
            Notification::create([
                'users_id' => $request->to_id,
                'type' => 'message',
                'title' => 'New Message',
                'message' => "You have a new message from {$currentUser->name}",
                'notification_settings_id' => $notificationSettingId,
                'read_at' => null
            ]);
        }
        
        $message->load(['user:id,name,photo', 'toUser:id,name,photo']);
        
        return response()->json([
            'success' => true,
            'message' => $message,
            'currentUserId' => $currentUser->id
        ]);
    }
    
    public function getUnreadCount()
    {
        $count = message::where('to_id', auth()->id())
            ->where('status', 'unread')
            ->count();
            
        return response()->json([
            'success' => true,
            'count' => $count
        ]);
    }
    
    public function getNotifications()
    {
        $user = auth()->user();
        if (!$user) {
            return response()->json([
                'success' => false,
                'notifications' => [],
                'unread_count' => 0
            ], 401);
        }
        
        // Use getUnreadNotifications() for unread count to respect notification settings
        // But also get all notifications for the dropdown
        $unreadNotifications = $user->getUnreadNotifications()->get();
        $unreadCount = $unreadNotifications->count();
        
        // Get all notifications (read and unread) for dropdown - limit to 50 then filter
        $allNotifications = Notification::where('users_id', $user->id)
            ->orderBy('created_at', 'desc')
            ->limit(50)
            ->get();
        
        // Filter notifications - include if they have notification_settings_id OR are special types
        $filteredNotifications = $allNotifications->filter(function($notification) use ($user) {
            // If notification has notification_settings_id, check if setting is active
            if ($notification->notification_settings_id) {
                $setting = \App\Models\notification_settings::where('id', $notification->notification_settings_id)
                    ->where('users_id', $user->id)
                    ->where('status', 'active')
                    ->first();
                
                if ($setting) {
                    return true;
                }
                
                // Check if user currently has active setting for the same module
                $originalSetting = \App\Models\notification_settings::where('id', $notification->notification_settings_id)
                    ->where('users_id', $user->id)
                    ->first();
                
                if ($originalSetting && $originalSetting->module_id) {
                    $currentSetting = \App\Models\notification_settings::where('users_id', $user->id)
                        ->where('module_id', $originalSetting->module_id)
                        ->where('status', 'active')
                        ->first();
                    return $currentSetting !== null;
                }
            }
            
            // Check if it's a business notification - Admin and Occupancy Manager should always see them
            $isBusinessNotification = stripos($notification->title ?? '', 'Business') !== false
                || stripos($notification->title ?? '', 'business') !== false
                || stripos($notification->message ?? '', 'business registration') !== false
                || stripos($notification->message ?? '', 'business added') !== false;
            
            if ($isBusinessNotification) {
                $userRole = strtolower(trim($user->role ?? ''));
                $isAdmin = $userRole === 'admin';
                $isOccupancyManager = in_array($userRole, ['occupancy manager', 'occupancies manager']);
                
                // Admin and Occupancy Manager should always see business notifications
                if ($isAdmin || $isOccupancyManager) {
                    return true;
                }
                
                // For other users, check if they have notification settings
                $businessModule = \App\Models\module::where(function($m) {
                    $m->where('module_name', 'business management')
                      ->orWhere('module_name', 'Business Management')
                      ->orWhere('module_name', 'business-management');
                })->where('status', 'active')->first();
                
                if ($businessModule) {
                    return \App\Models\notification_settings::where('users_id', $user->id)
                        ->where('module_id', $businessModule->id)
                        ->where('status', 'active')
                        ->exists();
                }
                return false;
            }
            
            // For other notifications without notification_settings_id, exclude them
            return false;
        });
        
        // Get latest 5 for dropdown
        $notifications = $filteredNotifications->take(5)->values();

        return response()->json([
            'success' => true,
            'notifications' => $notifications->map(function($n) {
                return [
                    'id' => $n->id,
                    'title' => $n->title ?? 'Notification',
                    'message' => $n->message ?? '',
                    'type' => $n->type ?? 'info',
                    'read_at' => $n->read_at,
                    'created_at' => $n->created_at ? $n->created_at->format('Y-m-d H:i:s') : now()->format('Y-m-d H:i:s')
                ];
            }),
            'unread_count' => $unreadCount
        ]);
    }
    
    public function markNotificationAsRead($notificationId)
    {
        $notification = Notification::where('id', $notificationId)
            ->where('users_id', auth()->id())
            ->first();
            
        if ($notification) {
            $notification->markAsRead();
            return response()->json(['success' => true]);
        }
        
        return response()->json(['success' => false, 'message' => 'Notification not found']);
    }
    
    public function markAllNotificationsAsRead()
    {
        Notification::where('users_id', auth()->id())
            ->whereNull('read_at')
            ->update(['read_at' => now()]);
            
        return response()->json(['success' => true]);
    }
    
    public function getLatestMessageSender()
    {
        $currentUser = auth()->user();
        
        // Get the latest unread message (exclude Non homeowners)
        $latestMessage = message::where('to_id', $currentUser->id)
            ->where('status', 'unread')
            ->whereHas('user', function($query) {
                $query->where('role', '!=', 'non home owners')
                      ->where('role', '!=', 'non-homeowner')
                      ->where('role', '!=', 'non homeowner')
                      ->where('role', '!=', 'non-homeowners');
            })
            ->with(['user:id,name,photo'])
            ->orderBy('created_at', 'desc')
            ->first();
            
        if ($latestMessage) {
            return response()->json([
                'success' => true,
                'sender' => [
                    'id' => $latestMessage->user->id,
                    'name' => $latestMessage->user->name,
                    'photo' => $latestMessage->user->photo ? asset('storage/profiles/' . $latestMessage->user->photo) : asset('img/user.jpg')
                ]
            ]);
        }
        
        return response()->json([
            'success' => false,
            'message' => 'No unread messages found'
        ]);
    }
    
    /**
     * Update the authenticated user's online presence.
     * Accepts: POST online=1|0
     */
    public function updatePresence(Request $request)
    {
        if (!auth()->check()) {
            return response()->json(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $request->validate([
            'online' => 'required|in:0,1',
        ]);

        $user = auth()->user();
        $user->is_online = (int) $request->online;
        $user->save();

        return response()->json([
            'success' => true,
            'online' => (int) $request->online,
        ]);
    }

    /**
     * Bulk fetch presence for a list of user IDs.
     * Accepts: GET ids[]=1&ids[]=2 ... or comma-separated ids
     */
    public function getPresence(Request $request)
    {
        if (!auth()->check()) {
            return response()->json(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $ids = $request->input('ids', []);
        if (is_string($ids)) {
            $ids = array_filter(explode(',', $ids));
        }
        if (!is_array($ids) || count($ids) === 0) {
            return response()->json(['success' => true, 'statuses' => []]);
        }

        $users = User::whereIn('id', $ids)->select('id', 'is_online')->get();
        $statuses = $users->map(function ($u) {
            return ['id' => $u->id, 'is_online' => (int) $u->is_online];
        })->values();

        return response()->json(['success' => true, 'statuses' => $statuses]);
    }
}
