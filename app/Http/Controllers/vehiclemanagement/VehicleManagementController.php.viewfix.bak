<?php

namespace App\Http\Controllers\vehiclemanagement;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\vehicle_homeowners;
use App\Models\vehicle_homeowners_supporting_documents;
use App\Models\vehicle_list_details_homeowners;
use App\Models\User;
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;

class VehicleManagementController extends Controller
{
    public function index(Request $request)
    {
        // Build query for vehicles
        $query = vehicle_homeowners::with(['user', 'supportingDocuments.vehicleDetails.stickerControl']);
        
        // Apply search filter
        if ($request->has('search') && $request->search != '') {
            $search = $request->search;
            $query->where(function($q) use ($search) {
                $q->where('type_of_vehicle', 'like', "%{$search}%")
                  ->orWhere('status', 'like', "%{$search}%")
                  ->orWhereHas('user', function($q) use ($search) {
                      $q->where('name', 'like', "%{$search}%");
                  })
                  ->orWhereHas('supportingDocuments.vehicleDetails', function($q) use ($search) {
                      $q->where('owner', 'like', "%{$search}%")
                        ->orWhere('driver', 'like', "%{$search}%")
                        ->orWhere('plate_number', 'like', "%{$search}%")
                        ->orWhere('vehicle_model', 'like', "%{$search}%")
                        ->orWhere('color_of_vehicle', 'like', "%{$search}%");
                  });
            });
        }
        
        // Apply status filter - exclude archived by default, show only when explicitly requested
        if ($request->has('status') && $request->status != '' && $request->status != 'all') {
            if ($request->status === 'Archived') {
                $query->where('status', 'Archived');
            } else {
                // For other statuses, show only that status (archived items are excluded)
                $query->where('status', $request->status);
            }
        } else {
            // When showing all, exclude archived items by default
            $query->where('status', '!=', 'Archived');
        }
        
        $perPage = $request->input('per_page', 10);
        $vehicles = $query->latest()->paginate($perPage);
        
        // Get unique statuses for filter (excluding archived from main list, it will be added separately)
        $statuses = vehicle_homeowners::distinct()
            ->pluck('status')
            ->filter(function($status) {
                return $status !== 'Archived';
            })
            ->sort()
            ->values();
        
        // Get Vehicle Sticker Form template paths (check for any extension)
        $homeownerTemplatePath = null;
        $nonHomeownerTemplatePath = null;
        if (Storage::disk('public')->exists('vehicle_templates')) {
            $files = Storage::disk('public')->files('vehicle_templates');
            foreach ($files as $file) {
                $fileName = basename($file);
                if (strpos($fileName, 'vehicle_sticker_form_homeowner') === 0) {
                    $homeownerTemplatePath = $file;
                } elseif (strpos($fileName, 'vehicle_sticker_form_nonhomeowner') === 0) {
                    $nonHomeownerTemplatePath = $file;
                }
            }
        }
            
        return view('vehiclemanagement.vehiclemanagement', compact('vehicles', 'statuses', 'homeownerTemplatePath', 'nonHomeownerTemplatePath'));
    }

    public function uploadStickerFormTemplate(Request $request)
    {
        try {
            $validated = $request->validate([
                'vehicle_sticker_form_template' => 'required|file|mimes:pdf,doc,docx,jpg,jpeg,png|max:10240',
                'template_type' => 'required|in:homeowner,nonhomeowner'
            ]);

            $file = $request->file('vehicle_sticker_form_template');
            $templateType = $validated['template_type'];
            $originalExtension = $file->getClientOriginalExtension();
            $fileName = 'vehicle_sticker_form_' . $templateType . '.' . $originalExtension; // Keep original extension
            
            // Create directory if it doesn't exist
            if (!Storage::disk('public')->exists('vehicle_templates')) {
                Storage::disk('public')->makeDirectory('vehicle_templates');
            }
            
            // Delete old template files for this type (any extension)
            $oldFiles = Storage::disk('public')->files('vehicle_templates');
            foreach ($oldFiles as $oldFile) {
                $oldFileName = basename($oldFile);
                if (strpos($oldFileName, 'vehicle_sticker_form_' . $templateType) === 0) {
                    Storage::disk('public')->delete($oldFile);
                }
            }
            
            // Store new template
            $file->storeAs('vehicle_templates', $fileName, 'public');

            return response()->json([
                'message' => ucfirst($templateType === 'homeowner' ? 'Homeowner' : 'Non-Homeowner') . ' Vehicle Sticker Form template uploaded successfully'
            ]);
        } catch (\Exception $e) {
            Log::error('Error uploading sticker form template: ' . $e->getMessage());
            return response()->json([
                'message' => 'Error uploading template: ' . $e->getMessage()
            ], 500);
        }
    }

    public function downloadStickerFormTemplate(Request $request)
    {
        try {
            $templateType = $request->get('type', 'homeowner'); // Default to homeowner if not specified
            
            // Validate template type
            if (!in_array($templateType, ['homeowner', 'nonhomeowner'])) {
                abort(400, 'Invalid template type. Must be homeowner or nonhomeowner.');
            }
            
            $directory = 'vehicle_templates';
            
            // Get the directory path from storage/app/public (where files are actually stored)
            $directoryPath = Storage::disk('public')->path($directory);
            
            // Check if directory exists
            if (!is_dir($directoryPath)) {
                abort(404, ucfirst($templateType === 'homeowner' ? 'Homeowner' : 'Non-Homeowner') . ' Vehicle Sticker Form template directory not found. Please upload a template first.');
            }
            
            // Get all files in the directory using glob
            $files = glob($directoryPath . '/*');
            
            // Filter out directories, keep only files
            $files = array_filter($files, function($file) {
                return is_file($file);
            });
            
            if (empty($files)) {
                abort(404, ucfirst($templateType === 'homeowner' ? 'Homeowner' : 'Non-Homeowner') . ' Vehicle Sticker Form template not found. Please upload a template first.');
            }
            
            // Find a file that starts with vehicle_sticker_form_{type}
            $templateFile = null;
            $searchPrefix = 'vehicle_sticker_form_' . $templateType;
            foreach ($files as $file) {
                $fileName = basename($file);
                if (strpos($fileName, $searchPrefix) === 0) {
                    $templateFile = $file;
                    break;
                }
            }
            
            // Verify file exists
            if (!$templateFile || !file_exists($templateFile)) {
                abort(404, ucfirst($templateType === 'homeowner' ? 'Homeowner' : 'Non-Homeowner') . ' Vehicle Sticker Form template file not found.');
            }
            
            // Get the filename and determine MIME type
            $fileName = basename($templateFile);
            $mimeType = mime_content_type($templateFile);
            
            // Get file modification time for cache-busting
            $lastModified = filemtime($templateFile);
            
            // Return file to view in browser (inline) with cache control headers
            return response()->file($templateFile, [
                'Content-Type' => $mimeType,
                'Content-Disposition' => 'inline; filename="' . $fileName . '"',
                'Cache-Control' => 'no-cache, no-store, must-revalidate',
                'Pragma' => 'no-cache',
                'Expires' => '0',
                'Last-Modified' => gmdate('D, d M Y H:i:s', $lastModified) . ' GMT',
                'ETag' => md5_file($templateFile)
            ]);
        } catch (\Illuminate\Http\Exceptions\HttpResponseException $e) {
            // Re-throw HTTP exceptions (like abort)
            throw $e;
        } catch (\Exception $e) {
            Log::error('Error viewing sticker form template: ' . $e->getMessage());
            Log::error('Stack trace: ' . $e->getTraceAsString());
            abort(404, 'Error viewing template: ' . $e->getMessage());
        }
    }

    public function show($id)
    {
        $vehicle = vehicle_homeowners::with(['user', 'supportingDocuments.vehicleDetails.stickerControl'])->findOrFail($id);
        
        return response()->json([
            'vehicle' => $vehicle,
            'supporting_documents' => $vehicle->supportingDocuments,
            'vehicle_details' => $vehicle->supportingDocuments?->vehicleDetails
        ]);
    }

    public function approve($id)
    {
        try {
            DB::beginTransaction();
            
            $vehicle = vehicle_homeowners::findOrFail($id);
            $vehicle->status = 'Approved';
            $vehicle->save();
            
            // Update status in vehicle_homeowners_supporting_documents table
            if ($vehicle->supportingDocuments) {
                $vehicle->supportingDocuments->status = 'Approved';
                $vehicle->supportingDocuments->save();
            }
            
            // Update status in vehicle_list_details_homeowners table
            if ($vehicle->supportingDocuments && $vehicle->supportingDocuments->vehicleDetails) {
                // Generate control number
                $controlNumber = $this->generateControlNumber();
                
                // Create sticker control number record first
                $stickerControl = \App\Models\sticker_control_number::create([
                    'vehicle_list_details_homeowners_id' => $vehicle->supportingDocuments->vehicleDetails->id,
                    'control_number' => $controlNumber,
                    'status' => 'Active'
                ]);
                
                // Update vehicle details with status and sticker control ID
                $vehicle->supportingDocuments->vehicleDetails->status = 'Approved';
                $vehicle->supportingDocuments->vehicleDetails->vehicle_sticker_control_no = $stickerControl->id;
                $vehicle->supportingDocuments->vehicleDetails->save();
            }
            
            DB::commit();
            
            return response()->json([
                'message' => 'Vehicle approved successfully. Please set the validity date.',
                'vehicle' => $vehicle->fresh(),
                'control_number' => $controlNumber ?? null,
                'sticker_id' => $stickerControl->id ?? null
            ]);
        } catch (\Exception $e) {
            DB::rollback();
            Log::error('Error approving vehicle: ' . $e->getMessage());
            return response()->json([
                'error' => 'Error approving vehicle: ' . $e->getMessage()
            ], 500);
        }
    }

    private function generateControlNumber()
    {
        // Generate a unique control number (you can customize this format)
        $prefix = 'SCN';
        $year = date('Y');
        $random = str_pad(rand(1, 9999), 4, '0', STR_PAD_LEFT);
        
        return $prefix . $year . $random;
    }

    public function updateValidUntil(Request $request, $id)
    {
        try {
            $validated = $request->validate([
                'valid_until' => 'required|date|after:today',
            ]);
            
            $stickerControl = \App\Models\sticker_control_number::findOrFail($id);
            $stickerControl->valid_until = $validated['valid_until'];
            $stickerControl->save();
            
            return response()->json([
                'message' => 'Validity date set successfully',
                'sticker_control' => $stickerControl
            ]);
        } catch (\Exception $e) {
            Log::error('Error setting validity date: ' . $e->getMessage());
            return response()->json([
                'error' => 'Error setting validity date: ' . $e->getMessage()
            ], 500);
        }
    }

    public function decline(Request $request, $id)
    {
        try {
            $validated = $request->validate([
                'reason' => 'required|string|max:1000',
            ]);
            
            $vehicle = vehicle_homeowners::findOrFail($id);
            $vehicle->status = 'Declined';
            $vehicle->save();
            
            // Update status in vehicle_homeowners_supporting_documents table
            if ($vehicle->supportingDocuments) {
                $vehicle->supportingDocuments->status = 'Declined';
                $vehicle->supportingDocuments->save();
            }
            
            // Update status and store reason in vehicle_list_details_homeowners table
            if ($vehicle->supportingDocuments && $vehicle->supportingDocuments->vehicleDetails) {
                $vehicle->supportingDocuments->vehicleDetails->status = 'Declined';
                $vehicle->supportingDocuments->vehicleDetails->reason = $validated['reason'];
                $vehicle->supportingDocuments->vehicleDetails->save();
            }
            
            return response()->json([
                'message' => 'Vehicle declined successfully',
                'vehicle' => $vehicle->fresh()
            ]);
        } catch (\Exception $e) {
            Log::error('Error declining vehicle: ' . $e->getMessage());
            return response()->json([
                'error' => 'Error declining vehicle: ' . $e->getMessage()
            ], 500);
        }
    }

    public function store(Request $request)
    {
        try {
            $validated = $request->validate([
                'type_of_vehicle' => ['required', 'string', 'max:255'],
                'status' => ['required', Rule::in(['Pending', 'Active', 'Inactive'])],
                'owner' => ['required', 'string', 'max:255'],
                'driver' => ['required', 'string', 'max:255'],
                'plate_number' => ['required', 'string', 'max:20'],
                'or_no' => ['required', 'string', 'max:50'],
                'vehicle_model' => ['required', 'string', 'max:255'],
                'cr_no' => ['required', 'string', 'max:50'],
                'color_of_vehicle' => ['required', 'string', 'max:100'],
                'supporting_documents_attachments.*' => 'nullable|file|mimes:pdf,doc,docx,jpg,jpeg,png|max:10240'
            ]);

            DB::beginTransaction();

            // Handle multiple file uploads
            $filePaths = [];
            if ($request->hasFile('supporting_documents_attachments')) {
                foreach ($request->file('supporting_documents_attachments') as $file) {
                    $fileName = time() . '_' . uniqid() . '_' . $file->getClientOriginalName();
                    $filePath = $file->storeAs('vehicle_documents', $fileName, 'public');
                    $filePaths[] = $filePath;
                }
            }

            // Create vehicle homeowner record
            $vehicleHomeowner = vehicle_homeowners::create([
                'user_id' => auth()->id(), // Use logged in user
                'type_of_vehicle' => $validated['type_of_vehicle'],
                'status' => $validated['status']
            ]);

            // Create supporting documents record - store as JSON array
            $supportingDocuments = vehicle_homeowners_supporting_documents::create([
                'vehicle_homeowners_id' => $vehicleHomeowner->id,
                'supporting_documents_attachments' => !empty($filePaths) ? json_encode($filePaths) : null,
                'status' => $validated['status']
            ]);

            // Create vehicle details record
            vehicle_list_details_homeowners::create([
                'vehicle_homeowners_supporting_documents_id' => $supportingDocuments->id,
                'owner' => $validated['owner'],
                'driver' => $validated['driver'],
                'plate_number' => $validated['plate_number'],
                'or_no' => $validated['or_no'],
                'vehicle_model' => $validated['vehicle_model'],
                'cr_no' => $validated['cr_no'],
                'color_of_vehicle' => $validated['color_of_vehicle'],
                'vehicle_sticker_control_no' => null,
                'status' => $validated['status']
            ]);

            DB::commit();

            return response()->json([
                'message' => 'Vehicle saved successfully',
                'id' => $vehicleHomeowner->id
            ], 201);

        } catch (\Exception $e) {
            DB::rollback();
            return response()->json([
                'message' => 'Error saving vehicle: ' . $e->getMessage()
            ], 500);
        }
    }

    public function update(Request $request, $id)
    {
        try {
            $vehicle = vehicle_homeowners::findOrFail($id);
            
            $validated = $request->validate([
                'type_of_vehicle' => ['required', 'string', 'max:255'],
                'status' => ['required', Rule::in(['Pending', 'Active', 'Inactive'])],
                'owner' => ['required', 'string', 'max:255'],
                'driver' => ['required', 'string', 'max:255'],
                'plate_number' => ['required', 'string', 'max:20'],
                'or_no' => ['required', 'string', 'max:50'],
                'vehicle_model' => ['required', 'string', 'max:255'],
                'cr_no' => ['required', 'string', 'max:50'],
                'color_of_vehicle' => ['required', 'string', 'max:100'],
                'supporting_documents_attachments.*' => 'nullable|file|mimes:pdf,doc,docx,jpg,jpeg,png|max:10240'
            ]);

            DB::beginTransaction();

            $vehicle->update([
                'type_of_vehicle' => $validated['type_of_vehicle'],
                'status' => $validated['status']
            ]);

            if ($vehicle->supportingDocuments) {
                // Get existing files
                $existingFiles = $vehicle->supportingDocuments->supporting_documents_attachments;
                $existingFilePaths = $existingFiles ? json_decode($existingFiles, true) : [];
                
                // If not an array, convert to array (backward compatibility)
                if (!is_array($existingFilePaths)) {
                    $existingFilePaths = $existingFiles ? [$existingFiles] : [];
                }
                
                // Handle multiple file uploads for update
                if ($request->hasFile('supporting_documents_attachments')) {
                    // Delete old files
                    foreach ($existingFilePaths as $oldFile) {
                        if ($oldFile && Storage::disk('public')->exists($oldFile)) {
                            Storage::disk('public')->delete($oldFile);
                        }
                    }
                    
                    // Upload new files
                    $newFilePaths = [];
                    foreach ($request->file('supporting_documents_attachments') as $file) {
                        $fileName = time() . '_' . uniqid() . '_' . $file->getClientOriginalName();
                        $filePath = $file->storeAs('vehicle_documents', $fileName, 'public');
                        $newFilePaths[] = $filePath;
                    }
                    
                    $existingFilePaths = $newFilePaths;
                }

                $vehicle->supportingDocuments->update([
                    'supporting_documents_attachments' => !empty($existingFilePaths) ? json_encode($existingFilePaths) : null,
                    'status' => $validated['status']
                ]);

                if ($vehicle->supportingDocuments->vehicleDetails) {
                    // Preserve the existing sticker control number ID
                    $existingStickerControlNo = $vehicle->supportingDocuments->vehicleDetails->vehicle_sticker_control_no;
                    
                    $vehicle->supportingDocuments->vehicleDetails->update([
                        'owner' => $validated['owner'],
                        'driver' => $validated['driver'],
                        'plate_number' => $validated['plate_number'],
                        'or_no' => $validated['or_no'],
                        'vehicle_model' => $validated['vehicle_model'],
                        'cr_no' => $validated['cr_no'],
                        'color_of_vehicle' => $validated['color_of_vehicle'],
                        'vehicle_sticker_control_no' => $existingStickerControlNo,
                        'status' => $validated['status']
                    ]);
                }
            }

            DB::commit();

            return response()->json([
                'message' => 'Vehicle updated successfully'
            ]);
            
        } catch (\Exception $e) {
            DB::rollback();
            return response()->json([
                'message' => 'Error updating vehicle: ' . $e->getMessage()
            ], 500);
        }
    }

    public function destroy($id)
    {
        try {
            DB::beginTransaction();
            
            $vehicle = vehicle_homeowners::findOrFail($id);
            
            // Archive the vehicle instead of deleting
            $vehicle->status = 'Archived';
            $vehicle->save();
            
            // Update status in related records
            if ($vehicle->supportingDocuments) {
                $vehicle->supportingDocuments->status = 'Archived';
                $vehicle->supportingDocuments->save();
                
                if ($vehicle->supportingDocuments->vehicleDetails) {
                    $vehicle->supportingDocuments->vehicleDetails->status = 'Archived';
                    $vehicle->supportingDocuments->vehicleDetails->save();
                }
            }
            
            DB::commit();

            return response()->json([
                'message' => 'Vehicle archived successfully'
            ]);
            
        } catch (\Exception $e) {
            DB::rollback();
            return response()->json([
                'message' => 'Error archiving vehicle: ' . $e->getMessage()
            ], 500);
        }
    }

    public function unarchive($id)
    {
        try {
            DB::beginTransaction();
            
            $vehicle = vehicle_homeowners::findOrFail($id);
            
            // Check if vehicle is archived
            if ($vehicle->status !== 'Archived') {
                return response()->json([
                    'message' => 'Vehicle is not archived'
                ], 400);
            }
            
            // Unarchive the vehicle - set status back to Pending
            $vehicle->status = 'Pending';
            $vehicle->save();
            
            // Update status in related records
            if ($vehicle->supportingDocuments) {
                $vehicle->supportingDocuments->status = 'Pending';
                $vehicle->supportingDocuments->save();
                
                if ($vehicle->supportingDocuments->vehicleDetails) {
                    $vehicle->supportingDocuments->vehicleDetails->status = 'Pending';
                    $vehicle->supportingDocuments->vehicleDetails->save();
                }
            }
            
            DB::commit();

            return response()->json([
                'message' => 'Vehicle unarchived successfully and restored to Pending status'
            ]);
            
        } catch (\Exception $e) {
            DB::rollback();
            Log::error('Error unarchiving vehicle: ' . $e->getMessage());
            return response()->json([
                'message' => 'Error unarchiving vehicle: ' . $e->getMessage()
            ], 500);
        }
    }
}
