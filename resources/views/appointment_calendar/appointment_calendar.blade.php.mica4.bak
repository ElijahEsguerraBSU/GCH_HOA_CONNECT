@extends('layout._partials.master')

@section('content')
<div class="grid grid-cols-12 gap-5 mt-5">
    <!-- BEGIN: Calendar Side Menu -->
    <div class="col-span-12 xl:col-span-4 2xl:col-span-3">
        <div class="box p-5 intro-y">
           
                <h2 class="text-lg font-medium text-center">Calendar</h2>

            <div class="border-t border-b border-slate-200/60 dark:border-darkmode-400 mt-6 mb-5 py-3 overflow-y-auto overflow-x-hidden" id="calendar-events" style="max-height: 500px;">
                @forelse($appointments as $appointment)
                <div class="relative">
                    <div class="event px-3 py-3 cursor-pointer transition duration-300 ease-in-out hover:bg-slate-100 dark:hover:bg-darkmode-400 rounded-md flex items-start gap-3" data-appointment-id="{{ $appointment['id'] }}">
                        <div class="w-2 h-2 mt-1
                            @if($appointment['status'] === 'pending') bg-pending
                            @elseif($appointment['status'] === 'approved') bg-success
                            @elseif($appointment['status'] === 'cancelled') bg-danger
                            @elseif($appointment['status'] === 'completed') bg-primary
                            @else bg-warning
                            @endif 
                            rounded-full flex-shrink-0"></div>
                        <div class="flex-1 pr-10">
                            <div class="event__title font-medium text-slate-700 leading-snug break-words">{{ $appointment['description'] }}</div>
                            <div class="text-slate-500 text-xs mt-1 flex items-center flex-wrap gap-1">
                                @php
                                $scheduledTime = null;
                                if (!empty($appointment['time'])) {
                                    try {
                                        $scheduledTime = \Carbon\Carbon::parse($appointment['time'])->format('g:i A');
                                    } catch (\Exception $e) {
                                        $scheduledTime = $appointment['time'];
                                    }
                                }
                                @endphp
                                <span class="font-semibold text-slate-600">Scheduled Time:</span>
                                <span class="text-slate-600">{{ $scheduledTime ?? 'TBD' }}</span>
                            </div>
                        </div>
                    </div>
                    <a class="flex items-center justify-center absolute top-1/2 right-0 -translate-y-1/2 pr-1 view-appointment-btn" href="javascript:;" data-tw-toggle="modal" data-tw-target="#appointmentModal" data-appointment-id="{{ $appointment['id'] }}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" icon-name="eye" data-lucide="eye" class="lucide lucide-eye w-4 h-4 text-slate-500">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </a>
                </div>
                @empty
                <div class="text-slate-500 p-3 text-center" id="calendar-no-events">No events yet</div>
                @endforelse
            </div>

            <div class="form-check form-switch flex">
                <!-- <label class="form-check-label" for="checkbox-events">Remove after drop</label>
                                <input class="show-code form-check-input ml-auto" type="checkbox" id="checkbox-events"> -->
            </div>
        </div>
    </div>
    <!-- END: Calendar Side Menu -->

    <!-- BEGIN: Calendar Content -->
    <div class="col-span-12 xl:col-span-8 2xl:col-span-9">
        <div class="box p-5">
            <div class="full-calendar" id="calendar"></div>
        </div>
    </div>
    <!-- END: Calendar Content -->
</div>

<!-- BEGIN: Appointment Details Modal -->
<div id="appointmentModal" class="modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body px-5 py-10">
                <div id="appointment-details">
                    <div class="text-center text-slate-500 py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-lg">Loading appointment details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer px-5 py-3">
                <div class="flex justify-end gap-2">
                    <button type="button" data-tw-dismiss="modal" class="btn btn-outline-secondary w-24">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END: Appointment Details Modal -->

@endsection

@push('styles')
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css">
<style>
    /* CRITICAL: Completely hide all-day row in ALL views */
    /* Hide all-day container and divider in timeGrid views */
    .fc-timegrid-all-day,
    .fc-timegrid-all-day-container,
    .fc-timegrid-divider,
    .fc-timegrid-all-day-table,
    .fc-timegrid-all-day-frame,
    .fc-timegrid-all-day-col,
    .fc-timegrid-all-day-col-table,
    .fc-timegrid-all-day-col-frame {
        display: none !important;
        height: 0 !important;
        min-height: 0 !important;
        max-height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        overflow: hidden !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* Hide all-day slot in week and day views - more specific selectors */
    .fc-timeGridWeek-view .fc-timegrid-all-day,
    .fc-timeGridDay-view .fc-timegrid-all-day,
    .fc-timeGridWeek-view .fc-timegrid-all-day-container,
    .fc-timeGridDay-view .fc-timegrid-all-day-container,
    .fc-timeGridWeek-view .fc-timegrid-divider,
    .fc-timeGridDay-view .fc-timegrid-divider,
    .fc-timeGridWeek-view .fc-timegrid-all-day-table,
    .fc-timeGridDay-view .fc-timegrid-all-day-table,
    .fc-timeGridWeek-view .fc-timegrid-all-day-frame,
    .fc-timeGridDay-view .fc-timegrid-all-day-frame {
        display: none !important;
        height: 0 !important;
        min-height: 0 !important;
        max-height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        overflow: hidden !important;
        visibility: hidden !important;
        opacity: 0 !important;
        border: none !important;
    }
    
    /* Hide all-day events that might appear in the time grid */
    .fc-timegrid-event.fc-event-allday,
    .fc-timegrid-event[data-all-day="true"],
    .fc-event[data-all-day="true"] {
        display: none !important;
    }
    
    /* Ensure time grid starts at the top without all-day section */
    .fc-timegrid-body {
        margin-top: 0 !important;
    }
    
    .fc-timegrid-slot-lane {
        border-top: 1px solid #ddd !important;
    }
    
    /* REMOVE "all-day" text completely from List view */
    .fc-list-event-time::before {
        content: '' !important;
        display: none !important;
    }
    
    /* Hide the entire time column in List view that shows "all-day" */
    .fc-list-event-time {
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Alternative: Hide any text that contains "all-day" */
    .fc-list-event-time:contains("all-day"),
    td.fc-list-event-time {
        display: none !important;
    }
    
    /* Hide Week and Day view buttons */
    .fc-timeGridWeek-button,
    .fc-timeGridDay-button,
    button.fc-timeGridWeek-button,
    button.fc-timeGridDay-button,
    .fc-button-group button[data-view="timeGridWeek"],
    .fc-button-group button[data-view="timeGridDay"],
    .fc-toolbar-chunk button[data-view="timeGridWeek"],
    .fc-toolbar-chunk button[data-view="timeGridDay"] {
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        overflow: hidden !important;
    }
    
    /* Custom FullCalendar Event Styles */
    .fc-event {
        border: none !important;
        border-radius: 4px !important;
        padding: 2px 4px !important;
        font-size: 12px !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        pointer-events: auto !important;
    }

    .fc-event:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        cursor: pointer !important;
    }

    .fc-event-past {
        opacity: 0.6;
        cursor: pointer !important;
    }

    .fc-event-future {
        cursor: pointer !important;
    }

    .fc-event-main {
        padding: 0 !important;
    }

    .fc-event-title {
        color: #ffffff !important;
        font-weight: 600 !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    }

    .appointment-event {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
    }

    .appointment-event.fc-event {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
    }

    /* Modal Styles - Standard Tailwind UI Modal */
    #appointmentModal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
        overflow-x: hidden !important;
    }

    /* Prevent overflow in modal content */
    #appointmentModal .modal-content {
        overflow-x: hidden !important;
        word-wrap: break-word;
        max-width: 100%;
    }

    /* Prevent overflow in modal dialog */
    #appointmentModal .modal-dialog {
        max-width: 100%;
        overflow-x: hidden !important;
    }

    /* Prevent text overflow in modal fields */
    #appointmentModal .modal-body * {
        max-width: 100% !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        box-sizing: border-box !important;
    }

    /* Ensure grid items don't overflow */
    #appointmentModal .grid {
        max-width: 100% !important;
        overflow-x: hidden !important;
    }

    #appointmentModal .grid > * {
        min-width: 0 !important;
        max-width: 100% !important;
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
    }

    /* Specific fix for text content */
    #appointmentModal .text-slate-800,
    #appointmentModal .text-slate-700 {
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        max-width: 100% !important;
    }

    /* Modal Styles - Let Tailwind handle everything, only fix overflow */
    #appointmentModal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
        overflow-x: hidden;
    }

    /* Ensure body scrolling is restored when modal is closed */
    body:not(.modal-open) {
        overflow: auto !important;
        overflow-y: auto !important;
        overflow-x: auto !important;
    }

    html:not(.modal-open) {
        overflow: auto !important;
        overflow-y: auto !important;
        overflow-x: auto !important;
    }

    /* Force restore scrolling after modal is closed */
    body.modal-closed {
        overflow: auto !important;
        overflow-y: auto !important;
        overflow-x: auto !important;
    }
</style>
@endpush

@push('scripts')
<!-- FullCalendar must load BEFORE our script -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
    // Pass appointments data to JavaScript
    window.appointmentsData = @json($appointments);
    console.log('Appointments data set:', window.appointmentsData?.length || 0, 'appointments');
</script>
<script src="{{ asset('js/appointment_calendar/appointment_calendar.js') }}"></script>
@endpush